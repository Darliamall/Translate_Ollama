<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>会议室中英文实时翻译系统 | Ollama本地大模型</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
        }
        
        header {
            background: linear-gradient(to right, #0d47a1, #1565c0);
            padding: 25px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #42a5f5;
        }
        
        h1 {
            font-size: 2.8rem;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .status-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #f44336;
            box-shadow: 0 0 10px #f44336;
        }
        
        .status-indicator.connected {
            background-color: #4caf50;
            box-shadow: 0 0 10px #4caf50;
        }
        
        .status-text {
            font-size: 1.4rem;
            font-weight: 500;
        }
        
        .main-content {
            display: flex;
            min-height: 70vh;
            padding: 20px;
            gap: 20px;
        }
        
        .panel {
            flex: 1;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            display: flex;
            flex-direction: column;
            border: 2px solid rgba(66, 165, 245, 0.3);
        }
        
        .panel-title {
            font-size: 2rem;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #42a5f5;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .panel-title .lang-indicator {
            font-size: 1.8rem;
            padding: 5px 15px;
            border-radius: 50px;
            background-color: #1565c0;
        }
        
        .translation-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 25px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .message {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            font-size: 1.8rem;
            line-height: 1.6;
            border-left: 5px solid #42a5f5;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }
        
        .message:hover {
            transform: translateY(-5px);
        }
        
        .message-source {
            background-color: rgba(33, 150, 243, 0.2);
        }
        
        .message-translated {
            background-color: rgba(76, 175, 80, 0.2);
            border-left-color: #4caf50;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 1.3rem;
            opacity: 0.8;
        }
        
        .message-time {
            font-size: 1.2rem;
        }
        
        .message-content {
            word-break: break-word;
            min-height: 30px;
        }
        
        .control-panel {
            padding: 30px;
            background-color: rgba(0, 0, 0, 0.5);
            border-top: 2px solid #42a5f5;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .btn {
            padding: 18px 35px;
            font-size: 1.8rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-weight: 600;
            transition: all 0.3s;
            min-width: 220px;
        }
        
        .btn-start {
            background: linear-gradient(to right, #4caf50, #2e7d32);
            color: white;
        }
        
        .btn-stop {
            background: linear-gradient(to right, #f44336, #c62828);
            color: white;
        }
        
        .btn-clear {
            background: linear-gradient(to right, #ff9800, #ef6c00);
            color: white;
        }
        
        .btn-export {
            background: linear-gradient(to right, #9c27b0, #6a1b9a);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .ollama-config {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            border: 1px solid rgba(66, 165, 245, 0.5);
        }
        
        .config-title {
            font-size: 1.6rem;
            margin-bottom: 15px;
            color: #bbdefb;
        }
        
        .config-info {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .config-item {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
        }
        
        .config-label {
            font-size: 1.2rem;
            color: #90caf9;
            margin-bottom: 5px;
        }
        
        .config-value {
            font-size: 1.4rem;
            font-weight: 500;
        }
        
        .config-value.connected {
            color: #4caf50;
        }
        
        .config-value.disconnected {
            color: #f44336;
        }
        
        .voice-indicator {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }
        
        .voice-icon {
            font-size: 2.5rem;
        }
        
        .voice-level {
            flex: 1;
            height: 30px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
        }
        
        .voice-level-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(to right, #4caf50, #ffeb3b, #f44336);
            transition: width 0.1s;
        }
        
        .mic-permission {
            background-color: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 1.4rem;
            display: none;
        }
        
        .mic-permission.show {
            display: block;
        }
        
        .translation-direction {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 25px;
            font-size: 1.8rem;
            background-color: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
        }
        
        .direction-arrow {
            font-size: 2.5rem;
            color: #42a5f5;
        }
        
        .language-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 1.2rem;
            margin-left: 10px;
            background-color: #2196f3;
            color: white;
        }
        
        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
            }
            
            .btn {
                min-width: 200px;
            }
        }
        
        @media (max-width: 768px) {
            .control-panel {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn {
                width: 100%;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .panel-title {
                font-size: 1.6rem;
            }
            
            .message {
                font-size: 1.4rem;
                padding: 15px;
            }
        }
        
        /* 滚动条样式 */
        ::-webkit-scrollbar {
            width: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #42a5f5;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #1e88e5;
        }
        
        .no-select {
            user-select: none;
        }
        
        .instructions {
            background-color: rgba(33, 150, 243, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            font-size: 1.4rem;
            line-height: 1.6;
            border-left: 5px solid #2196f3;
        }
        
        .interim-message {
            opacity: 0.7;
            border-style: dashed;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 0.9; }
            100% { opacity: 0.7; }
        }
        
        .config-control {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            align-items: center;
        }
        
        .config-input {
            flex: 1;
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #42a5f5;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1.2rem;
        }
        
        .config-btn {
            padding: 10px 20px;
            background-color: #42a5f5;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
        }
        
        .config-btn:hover {
            background-color: #1e88e5;
        }
        
        .error-message {
            background-color: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 1.3rem;
            display: none;
        }
        
        .error-message.show {
            display: block;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-language"></i> 会议室中英文实时翻译系统</h1>
            <div class="status-container">
                <div class="status-indicator" id="statusIndicator"></div>
                <div class="status-text" id="statusText">正在连接Ollama...</div>
            </div>
        </header>
        
        <div class="ollama-config">
            <div class="config-title"><i class="fas fa-cogs"></i> Ollama本地大模型配置</div>
            <div class="config-info">
                <div class="config-item">
                    <div class="config-label">模型名称</div>
                    <div class="config-value" id="modelName">deepseek-v3.1:671b-cloud</div>
                </div>
                <div class="config-item">
                    <div class="config-label">服务器地址</div>
                    <div class="config-value" id="serverUrl">http://localhost:11434</div>
                </div>
                <div class="config-item">
                    <div class="config-label">连接状态</div>
                    <div class="config-value disconnected" id="connectionStatus">检查中...</div>
                </div>
                <div class="config-item">
                    <div class="config-label">翻译方向</div>
                    <div class="config-value" id="translationDirection">自动检测 (中↔英)</div>
                </div>
            </div>
            
            <div class="config-control">
                <input type="text" id="customModelName" class="config-input" placeholder="输入其他模型名称 (如: deepseek-v3.1:671b-cloud)">
                <button id="updateModelBtn" class="config-btn">更新模型</button>
            </div>
            
            <div class="error-message" id="configError">
                <i class="fas fa-exclamation-triangle"></i> <span id="errorText"></span>
            </div>
        </div>
        
        <div class="translation-direction">
            <div class="lang-indicator" id="sourceLangDisplay">识别输入结果</div>
            <div class="direction-arrow"><i class="fas fa-exchange-alt"></i></div>
            <div class="lang-indicator" id="targetLangDisplay">实时翻译结果</div>
        </div>
        
        <div class="main-content">
            <div class="panel">
                <div class="panel-title">
                    <span><i class="fas fa-microphone"></i> 识别输入结果</span>
                    <span class="lang-indicator" id="sourceLang">检测中...</span>
                </div>
                
                <div class="instructions">
                    <i class="fas fa-info-circle"></i> 点击"开始监听"按钮，系统将开始实时识别麦克风语音内容。支持中文和英文输入，识别结果将实时显示在这里。
                </div>
                
                <div class="mic-permission" id="micPermission">
                    <i class="fas fa-exclamation-triangle"></i> 需要麦克风权限才能使用语音识别功能。请点击浏览器地址栏中的麦克风图标并允许访问。
                </div>
                
                <div class="voice-indicator">
                    <div class="voice-icon">
                        <i class="fas fa-microphone" id="micIcon"></i>
                    </div>
                    <div class="voice-level">
                        <div class="voice-level-bar" id="voiceLevelBar"></div>
                    </div>
                    <div id="voiceStatus">麦克风未激活</div>
                </div>
                
                <div class="translation-container" id="sourceTextContainer">
                    <!-- 语音识别文本将在这里显示 -->
                    <div class="message message-source">
                        <div class="message-header">
                            <span>系统提示</span>
                            <span class="message-time" id="currentTime">--:--:--</span>
                        </div>
                        <div class="message-content">
                            点击"开始监听"按钮后，系统将实时识别麦克风中的语音内容并显示在这里。支持中文和英文。
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <div class="panel-title">
                    <span><i class="fas fa-globe-americas"></i> 实时翻译结果</span>
                    <span class="lang-indicator" id="targetLang">检测中...</span>
                </div>
                
                <div class="instructions">
                    <i class="fas fa-info-circle"></i> 识别输入结果将通过Ollama本地大模型实时翻译为另一种语言，并显示在此区域。
                </div>
                
                <div class="translation-container" id="translatedTextContainer">
                    <!-- 翻译文本将在这里显示 -->
                    <div class="message message-translated">
                        <div class="message-header">
                            <span>系统提示</span>
                            <span class="message-time" id="currentTime2">--:--:--</span>
                        </div>
                        <div class="message-content">
                            翻译结果将实时显示在这里。系统会自动检测输入语言并翻译成对应的目标语言。
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="control-panel">
            <button class="btn btn-start" id="startBtn">
                <i class="fas fa-microphone"></i> 开始监听
            </button>
            <button class="btn btn-stop" id="stopBtn" disabled>
                <i class="fas fa-stop"></i> 停止监听
            </button>
            <button class="btn btn-clear" id="clearBtn">
                <i class="fas fa-trash-alt"></i> 清除记录
            </button>
            <button class="btn btn-export" id="exportBtn">
                <i class="fas fa-file-export"></i> 导出记录
            </button>
        </div>
    </div>

    <script>
        // 全局变量
        let recognition = null;
        let isListening = false;
        let ollamaConnected = false;
        let conversationHistory = [];
        let currentSourceLanguage = '检测中...';
        let currentTargetLanguage = '检测中...';
        let lastInterimMessageId = null;
        let lastFinalMessageId = null;
        
        // 配置变量
        let ollamaConfig = {
            model: 'deepseek-v3.1:671b-cloud',  // 默认使用deepseek-v3.1:671b-cloud模型
            serverUrl: 'http://localhost:11434',
            apiPath: '/api/generate'
        };
        
        // DOM元素
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const clearBtn = document.getElementById('clearBtn');
        const exportBtn = document.getElementById('exportBtn');
        const sourceTextContainer = document.getElementById('sourceTextContainer');
        const translatedTextContainer = document.getElementById('translatedTextContainer');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const connectionStatus = document.getElementById('connectionStatus');
        const voiceLevelBar = document.getElementById('voiceLevelBar');
        const micIcon = document.getElementById('micIcon');
        const voiceStatus = document.getElementById('voiceStatus');
        const micPermission = document.getElementById('micPermission');
        const sourceLang = document.getElementById('sourceLang');
        const targetLang = document.getElementById('targetLang');
        const sourceLangDisplay = document.getElementById('sourceLangDisplay');
        const targetLangDisplay = document.getElementById('targetLangDisplay');
        const modelNameElement = document.getElementById('modelName');
        const serverUrlElement = document.getElementById('serverUrl');
        const customModelNameInput = document.getElementById('customModelName');
        const updateModelBtn = document.getElementById('updateModelBtn');
        const configError = document.getElementById('configError');
        const errorText = document.getElementById('errorText');
        
        // 初始化函数
        function init() {
            updateTime();
            setInterval(updateTime, 1000);
            
            // 显示当前配置
            updateConfigDisplay();
            
            // 检查Ollama连接状态
            checkOllamaConnection();
            
            // 初始化语音识别
            initSpeechRecognition();
            
            // 绑定事件
            startBtn.addEventListener('click', startListening);
            stopBtn.addEventListener('click', stopListening);
            clearBtn.addEventListener('click', clearConversation);
            exportBtn.addEventListener('click', exportConversation);
            updateModelBtn.addEventListener('click', updateModelConfig);
            customModelNameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    updateModelConfig();
                }
            });
            
            // 设置输入框默认值
            customModelNameInput.value = ollamaConfig.model;
            
            // 添加示例数据
            setTimeout(addExampleConversation, 3000);
        }
        
        // 更新配置显示
        function updateConfigDisplay() {
            modelNameElement.textContent = ollamaConfig.model;
            serverUrlElement.textContent = ollamaConfig.serverUrl;
        }
        
        // 更新模型配置
        function updateModelConfig() {
            const newModel = customModelNameInput.value.trim();
            if (!newModel) {
                showConfigError('请输入模型名称');
                return;
            }
            
            ollamaConfig.model = newModel;
            updateConfigDisplay();
            showConfigSuccess(`已切换模型为: ${newModel}`);
            
            // 重新检查连接状态
            checkOllamaConnection();
        }
        
        // 显示配置错误
        function showConfigError(message) {
            errorText.textContent = message;
            configError.classList.add('show');
            setTimeout(() => {
                configError.classList.remove('show');
            }, 5000);
        }
        
        // 显示配置成功
        function showConfigSuccess(message) {
            errorText.textContent = message;
            configError.style.backgroundColor = 'rgba(76, 175, 80, 0.2)';
            configError.style.borderColor = '#4caf50';
            configError.classList.add('show');
            
            setTimeout(() => {
                configError.classList.remove('show');
                configError.style.backgroundColor = '';
                configError.style.borderColor = '';
            }, 3000);
        }
        
        // 检查Ollama连接状态
        async function checkOllamaConnection() {
            try {
                const response = await fetch(`${ollamaConfig.serverUrl}/api/tags`, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const models = data.models || [];
                    
                    // 检查当前配置的模型是否可用
                    const modelAvailable = models.some(model => 
                        model.name.includes(ollamaConfig.model) || 
                        model.name === ollamaConfig.model
                    );
                    
                    ollamaConnected = true;
                    statusIndicator.classList.add('connected');
                    
                    if (modelAvailable) {
                        statusText.textContent = `Ollama已连接 (${ollamaConfig.model}可用)`;
                        connectionStatus.textContent = '已连接';
                        connectionStatus.className = 'config-value connected';
                    } else {
                        statusText.textContent = `Ollama已连接 (${ollamaConfig.model}未找到)`;
                        connectionStatus.textContent = '模型未找到';
                        connectionStatus.className = 'config-value disconnected';
                        showConfigError(`模型 ${ollamaConfig.model} 未找到，请确保已下载该模型`);
                    }
                } else {
                    throw new Error('连接失败');
                }
            } catch (error) {
                ollamaConnected = false;
                statusIndicator.classList.remove('connected');
                statusText.textContent = 'Ollama未连接';
                connectionStatus.textContent = '未连接';
                connectionStatus.className = 'config-value disconnected';
                
                console.warn(`无法连接到Ollama服务 (${ollamaConfig.serverUrl})，将使用模拟翻译功能。`);
                console.warn('请确保Ollama已启动并运行在正确地址');
                console.warn('错误详情:', error.message);
                
                showConfigError(`无法连接到Ollama服务: ${error.message}`);
            }
        }
        
        // 初始化语音识别
        function initSpeechRecognition() {
            // 检查浏览器是否支持语音识别
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('您的浏览器不支持语音识别功能。请使用Chrome、Edge或Safari浏览器。');
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            // 设置语音识别参数
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'zh-CN'; // 默认中文，但会自动检测语言
            
            // 语音识别开始
            recognition.onstart = function() {
                isListening = true;
                startBtn.disabled = true;
                stopBtn.disabled = false;
                micIcon.style.color = '#4caf50';
                voiceStatus.textContent = '正在监听...';
                console.log('语音识别已开始');
            };
            
            // 语音识别结果
            recognition.onresult = function(event) {
                let interimTranscript = '';
                let finalTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                // 处理临时识别结果
                if (interimTranscript.trim()) {
                    updateOrCreateInterimMessage(interimTranscript);
                }
                
                // 处理最终识别结果
                if (finalTranscript.trim()) {
                    handleFinalResult(finalTranscript);
                }
                
                // 模拟语音音量
                simulateVoiceLevel();
            };
            
            // 语音识别错误
            recognition.onerror = function(event) {
                console.error('语音识别错误:', event.error);
                
                if (event.error === 'not-allowed') {
                    micPermission.classList.add('show');
                }
                
                stopListening();
            };
            
            // 语音识别结束
            recognition.onend = function() {
                if (isListening) {
                    // 如果仍在监听状态，重新启动识别
                    recognition.start();
                } else {
                    micIcon.style.color = '#fff';
                    voiceStatus.textContent = '麦克风未激活';
                    voiceLevelBar.style.width = '0%';
                }
            };
        }
        
        // 更新或创建临时消息
        function updateOrCreateInterimMessage(text) {
            // 检测语言
            const detectedLang = detectLanguage(text);
            const langLabel = detectedLang === 'zh' ? '中文' : 'English';
            
            // 更新语言指示器
            sourceLang.textContent = langLabel;
            sourceLangDisplay.textContent = detectedLang === 'zh' ? '中文输入' : '英文输入';
            
            // 如果有临时消息，更新它
            if (lastInterimMessageId) {
                const interimMessage = document.getElementById(lastInterimMessageId);
                if (interimMessage) {
                    interimMessage.querySelector('.message-content').textContent = text;
                    interimMessage.querySelector('.language-badge').textContent = langLabel;
                    return;
                }
            }
            
            // 如果没有临时消息，创建新的临时消息
            const messageId = 'interim_' + Date.now();
            lastInterimMessageId = messageId;
            
            const messageElement = document.createElement('div');
            messageElement.className = 'message message-source interim-message';
            messageElement.id = messageId;
            messageElement.innerHTML = `
                <div class="message-header">
                    <span>识别输入结果 <span class="language-badge">${langLabel}</span></span>
                    <span class="message-time">${getCurrentTime()}</span>
                </div>
                <div class="message-content">${text}</div>
            `;
            
            // 移除之前的临时消息
            const oldInterimMessages = sourceTextContainer.querySelectorAll('.interim-message');
            oldInterimMessages.forEach(msg => {
                if (msg.id !== messageId) {
                    msg.remove();
                }
            });
            
            sourceTextContainer.appendChild(messageElement);
            sourceTextContainer.scrollTop = sourceTextContainer.scrollHeight;
        }
        
        // 处理最终结果
        function handleFinalResult(text) {
            // 检测语言
            const detectedLang = detectLanguage(text);
            const langLabel = detectedLang === 'zh' ? '中文' : 'English';
            
            // 更新语言指示器
            sourceLang.textContent = langLabel;
            sourceLangDisplay.textContent = detectedLang === 'zh' ? '中文输入' : '英文输入';
            
            // 确定目标语言
            currentTargetLanguage = detectedLang === 'zh' ? 'English' : '中文';
            targetLang.textContent = currentTargetLanguage;
            targetLangDisplay.textContent = detectedLang === 'zh' ? '英文翻译' : '中文翻译';
            
            // 生成唯一ID
            const messageId = 'final_' + Date.now();
            lastFinalMessageId = messageId;
            
            // 删除临时消息
            if (lastInterimMessageId) {
                const interimMessage = document.getElementById(lastInterimMessageId);
                if (interimMessage) {
                    interimMessage.remove();
                }
                lastInterimMessageId = null;
            }
            
            // 创建最终消息
            const messageElement = document.createElement('div');
            messageElement.className = 'message message-source';
            messageElement.id = messageId;
            messageElement.innerHTML = `
                <div class="message-header">
                    <span>识别输入结果 <span class="language-badge">${langLabel}</span></span>
                    <span class="message-time">${getCurrentTime()}</span>
                </div>
                <div class="message-content">${text}</div>
            `;
            
            sourceTextContainer.appendChild(messageElement);
            sourceTextContainer.scrollTop = sourceTextContainer.scrollHeight;
            
            // 添加到历史记录
            conversationHistory.push({
                id: messageId,
                type: 'source',
                text: text,
                language: detectedLang,
                timestamp: new Date().toISOString()
            });
            
            // 开始翻译
            translateTextAsync(text, detectedLang);
        }
        
        // 异步翻译文本
        async function translateTextAsync(text, sourceLang) {
            const translatedText = await translateText(text, sourceLang);
            addTranslatedMessage(translatedText, sourceLang);
        }
        
        // 添加翻译消息
        function addTranslatedMessage(text, sourceLangType) {
            // 创建消息元素
            const messageElement = document.createElement('div');
            messageElement.className = 'message message-translated';
            messageElement.innerHTML = `
                <div class="message-header">
                    <span>实时翻译结果 <span class="language-badge">${sourceLangType === 'zh' ? 'English' : '中文'}</span></span>
                    <span class="message-time">${getCurrentTime()}</span>
                </div>
                <div class="message-content">${text}</div>
            `;
            
            translatedTextContainer.appendChild(messageElement);
            translatedTextContainer.scrollTop = translatedTextContainer.scrollHeight;
            
            // 添加到历史记录
            conversationHistory.push({
                type: 'translated',
                text: text,
                language: sourceLangType === 'zh' ? 'en' : 'zh',
                timestamp: new Date().toISOString()
            });
        }
        
        // 开始监听
        function startListening() {
            if (!recognition) {
                alert('语音识别未初始化');
                return;
            }
            
            try {
                recognition.start();
                micPermission.classList.remove('show');
            } catch (error) {
                console.error('无法启动语音识别:', error);
                alert('无法访问麦克风。请检查浏览器权限设置。');
            }
        }
        
        // 停止监听
        function stopListening() {
            if (recognition && isListening) {
                recognition.stop();
                isListening = false;
                startBtn.disabled = false;
                stopBtn.disabled = true;
                micIcon.style.color = '#fff';
                voiceStatus.textContent = '已停止';
                voiceLevelBar.style.width = '0%';
                
                // 清除临时消息
                if (lastInterimMessageId) {
                    const interimMessage = document.getElementById(lastInterimMessageId);
                    if (interimMessage) {
                        interimMessage.remove();
                    }
                    lastInterimMessageId = null;
                }
            }
        }
        
        // 检测文本语言
        function detectLanguage(text) {
            // 简单的中英文检测
            const chineseCharCount = (text.match(/[\u4e00-\u9fff]/g) || []).length;
            const englishWordCount = (text.match(/\b[a-zA-Z]+\b/g) || []).length;
            
            // 如果有中文字符，认为是中文
            if (chineseCharCount > 0) {
                return 'zh';
            }
            
            // 如果有英文单词，认为是英文
            if (englishWordCount > 0) {
                return 'en';
            }
            
            // 默认返回英文
            return 'en';
        }
        
        // 翻译文本 - 
        async function translateText(text, sourceLang) {
            // 如果Ollama未连接，使用模拟翻译
            if (!ollamaConnected) {
                return simulateTranslation(text, sourceLang);
            }
            
            const targetLang = sourceLang === 'zh' ? 'en' : 'zh';
            
            try {
                // 优化的提示词
                const prompt = sourceLang === 'zh' 
                    ? `Translate this Chinese text to English: "${text}"`
                    : `将这段英文翻译成中文: "${text}"`;
                
                // 调用Ollama API
                const response = await fetch(`${ollamaConfig.serverUrl}${ollamaConfig.apiPath}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: ollamaConfig.model,
                        prompt: prompt,
                        stream: false,
                        options: {
                            temperature: 0.3,
                            top_p: 0.9,
                            num_predict: 100
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP错误! 状态码: ${response.status}`);
                }
                
                const data = await response.json();
                
                // 提取翻译结果
                let translatedText = data.response || '';
                
                // 清理响应文本
                translatedText = translatedText.trim();
                
                // 移除可能的多余引号
                translatedText = translatedText.replace(/^["']|["']$/g, '');
                
                return translatedText || simulateTranslation(text, sourceLang);
            } catch (error) {
                console.error('翻译请求失败:', error);
                return simulateTranslation(text, sourceLang);
            }
        }
        
        // 模拟翻译（当Ollama不可用时）
        function simulateTranslation(text, sourceLang) {
            // 简单的模拟翻译
            if (sourceLang === 'zh') {
                // 模拟中文到英文翻译
                const translations = {
                    '你好': 'Hello',
                    '欢迎来到会议室': 'Welcome to the conference room',
                    '我们今天讨论项目进展': 'Today we are discussing project progress',
                    '请分享你的意见': 'Please share your opinion',
                    '谢谢大家的参与': 'Thank you all for your participation',
                    '这个方案需要进一步讨论': 'This proposal requires further discussion',
                    '我同意你的观点': 'I agree with your point',
                    '我们可以开始下一项议程': 'We can move on to the next agenda item',
                    '请确保会议记录完整': 'Please ensure the meeting minutes are complete',
                    '今天的会议到此结束': 'Today\'s meeting is adjourned'
                };
                
                // 检查是否有匹配的翻译
                for (const [key, value] of Object.entries(translations)) {
                    if (text.includes(key)) {
                        return value;
                    }
                }
                
                // 默认翻译
                return `Translation: ${text}`;
            } else {
                // 模拟英文到中文翻译
                const translations = {
                    'hello': '你好',
                    'welcome to the conference room': '欢迎来到会议室',
                    'today we are discussing project progress': '我们今天讨论项目进展',
                    'please share your opinion': '请分享你的意见',
                    'thank you all for your participation': '谢谢大家的参与',
                    'this proposal requires further discussion': '这个方案需要进一步讨论',
                    'i agree with your point': '我同意你的观点',
                    'we can move on to the next agenda item': '我们可以开始下一项议程',
                    'please ensure the meeting minutes are complete': '请确保会议记录完整',
                    'today\'s meeting is adjourned': '今天的会议到此结束'
                };
                
                // 检查是否有匹配的翻译
                const lowerText = text.toLowerCase();
                for (const [key, value] of Object.entries(translations)) {
                    if (lowerText.includes(key)) {
                        return value;
                    }
                }
                
                // 默认翻译
                return `翻译: ${text}`;
            }
        }
        
        // 模拟语音音量
        function simulateVoiceLevel() {
            if (!isListening) return;
            
            // 随机生成音量级别
            const level = Math.floor(Math.random() * 80) + 20;
            voiceLevelBar.style.width = `${level}%`;
            
            // 根据音量改变颜色
            if (level > 70) {
                voiceLevelBar.style.background = 'linear-gradient(to right, #4caf50, #ffeb3b, #f44336)';
            } else if (level > 40) {
                voiceLevelBar.style.background = 'linear-gradient(to right, #4caf50, #ffeb3b)';
            } else {
                voiceLevelBar.style.background = '#4caf50';
            }
        }
        
        // 清除对话记录
        function clearConversation() {
            if (!confirm('确定要清除所有翻译记录吗？')) {
                return;
            }
            
            // 保留系统提示
            const sourceMessages = sourceTextContainer.querySelectorAll('.message');
            const translatedMessages = translatedTextContainer.querySelectorAll('.message');
            
            // 删除除第一个（系统提示）外的所有消息
            for (let i = 1; i < sourceMessages.length; i++) {
                sourceMessages[i].remove();
            }
            
            for (let i = 1; i < translatedMessages.length; i++) {
                translatedMessages[i].remove();
            }
            
            // 清空历史记录
            conversationHistory = [];
            
            // 重置变量
            lastInterimMessageId = null;
            lastFinalMessageId = null;
            
            // 重置语言指示器
            sourceLang.textContent = '检测中...';
            targetLang.textContent = '检测中...';
            sourceLangDisplay.textContent = '识别输入结果';
            targetLangDisplay.textContent = '实时翻译结果';
        }
        
        // 导出对话记录
        function exportConversation() {
            if (conversationHistory.length === 0) {
                alert('没有可导出的对话记录');
                return;
            }
            
            // 构建导出文本
            let exportText = `会议室翻译记录 - ${new Date().toLocaleString()}\n\n`;
            exportText += `使用的模型: ${ollamaConfig.model}\n`;
            exportText += '='.repeat(50) + '\n\n';
            
            // 按时间顺序组织对话
            const organizedHistory = [];
            let currentPair = null;
            
            for (const item of conversationHistory) {
                if (item.type === 'source') {
                    if (currentPair) {
                        organizedHistory.push(currentPair);
                    }
                    currentPair = {
                        source: item,
                        translated: null
                    };
                } else if (item.type === 'translated' && currentPair) {
                    currentPair.translated = item;
                    organizedHistory.push(currentPair);
                    currentPair = null;
                }
            }
            
            // 如果有未配对的源消息
            if (currentPair) {
                organizedHistory.push(currentPair);
            }
            
            // 生成导出内容
            organizedHistory.forEach((pair, index) => {
                exportText += `对话 ${index + 1}:\n`;
                exportText += `时间: ${new Date(pair.source.timestamp).toLocaleTimeString()}\n`;
                exportText += `原文 (${pair.source.language === 'zh' ? '中文' : '英文'}): ${pair.source.text}\n`;
                
                if (pair.translated) {
                    exportText += `翻译 (${pair.translated.language === 'zh' ? '中文' : '英文'}): ${pair.translated.text}\n`;
                } else {
                    exportText += `翻译: (未翻译)\n`;
                }
                
                exportText += '\n' + '-'.repeat(40) + '\n\n';
            });
            
            // 创建下载链接
            const blob = new Blob([exportText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `translation-record-${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`已导出 ${organizedHistory.length} 条对话记录`);
        }
        
        // 添加示例对话
        function addExampleConversation() {
            const examples = [
                {
                    source: "欢迎各位参加今天的项目会议",
                    translated: "Welcome everyone to today's project meeting"
                },
                {
                    source: "Let's start by reviewing last week's progress",
                    translated: "让我们从回顾上周的进展开始"
                },
                {
                    source: "这个功能模块的开发进度如何？",
                    translated: "What is the development progress of this functional module?"
                }
            ];
            
            examples.forEach((example, index) => {
                setTimeout(() => {
                    // 模拟最终结果，不显示临时结果
                    handleFinalResult(example.source);
                }, index * 2000);
            });
        }
        
        // 更新时间显示
        function updateTime() {
            const now = new Date();
            const timeString = now.toTimeString().split(' ')[0];
            
            document.querySelectorAll('.message-time').forEach(el => {
                if (el.textContent === '--:--:--' || el.id === 'currentTime' || el.id === 'currentTime2') {
                    el.textContent = timeString;
                }
            });
        }
        
        // 获取当前时间字符串
        function getCurrentTime() {
            return new Date().toTimeString().split(' ')[0];
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
